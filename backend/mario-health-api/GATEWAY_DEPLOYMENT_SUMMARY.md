# API Gateway Deployment Summary

## Overview

This setup creates a Google Cloud API Gateway that fronts the `mario-health-api` Cloud Run service, enabling public access while respecting organization policies that prevent making Cloud Run services public.

## Files Created

1. **`api-gateway-config.yaml`** - OpenAPI 2.0 specification for the API Gateway
   - Configures CORS for: `http://localhost:3000`, `https://mario-health-frontend.vercel.app`, `https://mario-health-clean.vercel.app`
   - Routes all `/api/v1/*` requests to the Cloud Run service
   - Supports all HTTP methods (GET, POST, PUT, DELETE, PATCH, OPTIONS)

2. **`deploy-gateway.sh`** - Automated deployment script
   - Enables required APIs
   - Sets up service account with Cloud Run Invoker permissions
   - Creates API, API config, and Gateway
   - Outputs the gateway URL

3. **`API_GATEWAY_SETUP.md`** - Detailed setup and troubleshooting guide

## Quick Start

### 1. Deploy the API Gateway

```bash
cd backend/mario-health-api
./deploy-gateway.sh
```

The script will output the gateway URL at the end. Save this URL for the next step.

### 2. Update Frontend Configuration

After deployment, get the gateway URL:

```bash
gcloud api-gateway gateways describe mario-health-api-gateway \
  --location=us-central1 \
  --project=mario-mrf-data \
  --format='value(defaultHostname)'
```

Then update `frontend/.env.local`:

```bash
NEXT_PUBLIC_API_URL=https://<gateway-hostname>
```

Replace `<gateway-hostname>` with the actual hostname from the command above.

### 3. Test the Gateway

```bash
# Get gateway URL
GATEWAY_URL=$(gcloud api-gateway gateways describe mario-health-api-gateway \
  --location=us-central1 \
  --project=mario-mrf-data \
  --format='value(defaultHostname)')

# Test health endpoint
curl "https://${GATEWAY_URL}/api/v1/health"

# Test categories endpoint
curl "https://${GATEWAY_URL}/api/v1/categories"
```

## Manual Commands (Alternative)

If you prefer to run commands manually, see `API_GATEWAY_SETUP.md` for step-by-step instructions.

## CORS Configuration

The API Gateway is configured to allow CORS from:

- ✅ `http://localhost:3000` (local development)
- ✅ `https://mario-health-frontend.vercel.app`
- ✅ `https://mario-health-clean.vercel.app`

All methods, headers, and credentials are allowed.

## Architecture

```
Frontend (localhost:3000 or Vercel)
    ↓
API Gateway (public, handles CORS)
    ↓
Cloud Run Service (private, requires authentication)
```

The API Gateway acts as a public proxy that:
1. Handles CORS preflight requests
2. Authenticates with Cloud Run using a service account
3. Forwards requests to the Cloud Run service
4. Returns responses with proper CORS headers

## Important Notes

1. **Service Account**: The API Gateway uses a service account with `roles/run.invoker` permission to invoke the Cloud Run service.

2. **Path Translation**: The gateway uses `APPEND_PATH_TO_ADDRESS` to forward the full path (`/api/v1/*`) to the Cloud Run service.

3. **Backend URL**: The Cloud Run service URL is hardcoded in `api-gateway-config.yaml` as `https://mario-health-api-ei5wbr4h5a-uc.a.run.app`. Update this if your service URL changes.

4. **Gateway URL**: The gateway URL is generated by Google Cloud and will be in the format: `mario-health-api-gateway-<hash>-uc.a.run.app`

## Troubleshooting

See `API_GATEWAY_SETUP.md` for detailed troubleshooting steps.

## Next Steps

1. ✅ Deploy the API Gateway
2. ✅ Update `frontend/.env.local` with the gateway URL
3. ✅ Test the frontend to ensure API calls work
4. ✅ Verify CORS is working from all allowed origins


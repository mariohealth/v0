# Local Development Setup for Authentication

This guide explains how to configure the backend for local development and troubleshoot CORS/authentication issues.

## Environment Variables

### Required for Token Verification

Set `GOOGLE_ALLOWED_AUDIENCES` in your environment or `.env` file:

```bash
# For Cloud Run identity tokens (default setup)
# The audience should be your Cloud Run service URL
GOOGLE_ALLOWED_AUDIENCES=https://mario-health-api-ei5wbr4h5a-uc.a.run.app

# For local development, you can also use your local backend URL
# However, Cloud Run identity tokens will have the Cloud Run URL as audience
GOOGLE_ALLOWED_AUDIENCES=https://mario-health-api-ei5wbr4h5a-uc.a.run.app,http://localhost:8000

# For OAuth2 user tokens (if you want to support user login)
# Add your OAuth2 client ID
GOOGLE_ALLOWED_AUDIENCES=https://mario-health-api-ei5wbr4h5a-uc.a.run.app,123456789-abcdefg.apps.googleusercontent.com
```

### CORS Configuration

CORS is configured via `ALLOWED_ORIGINS`:

```bash
# Default includes localhost:3000 for local development
ALLOWED_ORIGINS=http://localhost:3000,http://127.0.0.1:3000,https://mario.health
```

## Token Types Supported

The backend now supports two types of Google tokens:

### 1. Cloud Run Identity Tokens (Current Setup)
- **Generated by**: Frontend service account via `/api/auth/token`
- **Audience**: Cloud Run service URL (e.g., `https://mario-health-api-ei5wbr4h5a-uc.a.run.app`)
- **Issuer**: `https://accounts.google.com` (for service accounts)
- **Use case**: Service-to-service authentication

### 2. Google OAuth2 ID Tokens (For Future User Login)
- **Generated by**: User OAuth2 login flow
- **Audience**: OAuth2 client ID (e.g., `123456789-abcdefg.apps.googleusercontent.com`)
- **Issuer**: `accounts.google.com` or `https://accounts.google.com`
- **Use case**: User authentication

## Cloud Run IAM Configuration for Local Development

For local development, you have two options:

### Option 1: Allow Unauthenticated Invocations (Easier for Development)

This allows your local backend to be called without authentication:

```bash
# Allow unauthenticated access to your Cloud Run service
gcloud run services update mario-health-api \
  --region=us-central1 \
  --allow-unauthenticated
```

**Note**: This makes the service publicly accessible. Use with caution and only for development/staging.

### Option 2: Use Service Account with Proper IAM (Recommended for Production)

1. **Create a service account** for local development:

```bash
gcloud iam service-accounts create mario-health-local-dev \
  --display-name="Mario Health Local Dev"
```

2. **Grant Cloud Run Invoker role**:

```bash
gcloud run services add-iam-policy-binding mario-health-api \
  --region=us-central1 \
  --member="serviceAccount:mario-health-local-dev@YOUR_PROJECT_ID.iam.gserviceaccount.com" \
  --role="roles/run.invoker"
```

3. **Create and download key**:

```bash
gcloud iam service-accounts keys create ~/mario-health-local-key.json \
  --iam-account=mario-health-local-dev@YOUR_PROJECT_ID.iam.gserviceaccount.com
```

4. **Set in frontend**:

```bash
# In frontend/.env.local
GOOGLE_APPLICATION_CREDENTIALS=/path/to/mario-health-local-key.json
```

## Testing Authentication

### 1. Test CORS and Basic Connectivity

```bash
# Run the comprehensive test script
cd backend/mario-health-api
chmod +x test_auth_cors.sh

# Test without token
./test_auth_cors.sh

# Test with token
./test_auth_cors.sh $(curl -s http://localhost:3000/api/auth/token | jq -r .token)
```

### 2. Test Whoami Endpoint

```bash
# Test without token (should return 401)
curl http://localhost:8000/api/v1/whoami

# Test with token
TOKEN=$(curl -s http://localhost:3000/api/auth/token | jq -r .token)
curl -H "Authorization: Bearer $TOKEN" http://localhost:8000/api/v1/whoami
```

### 3. Check Backend Logs

The backend now logs detailed token information:

- Token verification start
- Allowed audiences configuration
- Decoded token claims (iss, aud, email, sub, exp)
- Verification success/failure with detailed errors

Look for logs like:
```
üîç Token verification started. Allowed audiences: [...]
üìã Decoded token claims:
   - Issuer (iss): https://accounts.google.com
   - Audience (aud): https://mario-health-api-ei5wbr4h5a-uc.a.run.app
   - Email: service-account@project.iam.gserviceaccount.com
‚úÖ Token verified successfully.
```

## Common Issues and Solutions

### Issue: "GOOGLE_ALLOWED_AUDIENCES not configured"

**Solution**: Set the `GOOGLE_ALLOWED_AUDIENCES` environment variable:

```bash
export GOOGLE_ALLOWED_AUDIENCES=https://mario-health-api-ei5wbr4h5a-uc.a.run.app
```

### Issue: "Token audience does not match any allowed audience"

**Problem**: The token's audience doesn't match what's in `GOOGLE_ALLOWED_AUDIENCES`.

**Solution**:
1. Get a token and decode it to see the audience:
   ```bash
   TOKEN=$(curl -s http://localhost:3000/api/auth/token | jq -r .token)
   echo $TOKEN | cut -d. -f2 | base64 -d | jq .aud
   ```

2. Ensure `GOOGLE_ALLOWED_AUDIENCES` includes this value.

3. For Cloud Run tokens, the audience should be the Cloud Run service URL.

### Issue: CORS errors in browser

**Problem**: Frontend can't make requests due to CORS.

**Solution**:
1. Verify `localhost:3000` is in `ALLOWED_ORIGINS` (it's in the default)
2. Check backend logs for CORS headers:
   ```
   Origin: http://localhost:3000
   CORS Allowed Origin: http://localhost:3000
   ```
3. Ensure `allow_credentials=True` in CORS middleware (it's already set)

### Issue: "Invalid token issuer"

**Problem**: Token issuer doesn't match expected Google issuers.

**Current valid issuers**:
- `accounts.google.com`
- `https://accounts.google.com`
- `https://securetoken.google.com`

The backend logs will show the actual issuer. If it's different, you may need to update the issuer validation.

## Debugging Steps

1. **Check token generation**:
   ```bash
   curl http://localhost:3000/api/auth/token | jq .
   ```

2. **Decode token to see claims**:
   ```bash
   TOKEN=$(curl -s http://localhost:3000/api/auth/token | jq -r .token)
   echo $TOKEN | cut -d. -f2 | base64 -d | jq .
   ```

3. **Test with whoami endpoint**:
   ```bash
   TOKEN=$(curl -s http://localhost:3000/api/auth/token | jq -r .token)
   curl -H "Authorization: Bearer $TOKEN" http://localhost:8000/api/v1/whoami | jq .
   ```

4. **Check backend logs** for detailed verification logs

5. **Test CORS separately**:
   ```bash
   curl -X OPTIONS \
     -H "Origin: http://localhost:3000" \
     -H "Access-Control-Request-Method: GET" \
     -v http://localhost:8000/api/v1/categories
   ```

## Production Notes

- Always use service accounts with minimal required permissions
- Never commit service account keys to version control
- Use secrets management (GCP Secret Manager, etc.) for production
- Set appropriate CORS origins for production only
- Use Cloud Run IAM instead of allowing unauthenticated access in production

